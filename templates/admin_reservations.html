{% extends 'base.html' %}
{% block content %}
<div class="dashboard-container">
  <!-- Sidebar (reuse from admin.html) -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>UC - Admin</h2>
      <button class="sidebar-inner-toggle" title="Toggle Sidebar">
        <i class="fa fa-bars"></i>
      </button>
    </div>
    <div class="sidebar-menu">
      <ul>
        <li><a href="{{ url_for('admin_dashboard') }}"><i class="fa fa-dashboard"></i> Admin Dashboard</a></li>
        <li><a href="{{ url_for('admin_current_sit_in') }}"><i class="fa fa-users"></i> Current Sit-In</a></li>
        <li><a href="{{ url_for('admin_sit_in_records') }}"><i class="fa fa-list-alt"></i> View Sit-in Records</a></li>
        <li><a href="{{ url_for('admin_leaderboard') }}"><i class="fa fa-trophy"></i> Leaderboard</a></li>
        <li><a href="{{ url_for('admin_announcements') }}"><i class="fa fa-bullhorn"></i> Announcements</a></li>
        <li><a href="{{ url_for('admin_lab_resources') }}"><i class="fa fa-desktop"></i> Lab Resources</a></li>
        <li><a href="{{ url_for('admin_lab_schedule') }}"><i class="fa fa-calendar"></i> Lab Schedule</a></li>
        <li><a href="{{ url_for('admin_reservations') }}" class="active"><i class="fa fa-calendar-check-o"></i> Reservations</a></li>
        <li><a href="{{ url_for('admin_reports') }}"><i class="fa fa-file-text"></i> Generate Reports</a></li>
        <li><a href="{{ url_for('admin_feedback') }}"><i class="fa fa-comments"></i> View Feedback</a></li>
        <li style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;"><a href="{{ url_for('admin_system_management') }}"><i class="fa fa-cogs"></i> System</a></li>
      </ul>
    </div>
  </div>
  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>Lab Reservations</h1>
      <a class="Btn" href="{{ url_for('logout') }}">
        <div class="sign"><i class="fa fa-sign-out" aria-hidden="true"></i></div>
        <div class="text">Logout</div>
      </a>
    </div>
    <!-- Side by side containers -->
    <div class="content-row" style="display: flex; gap: 20px; margin-bottom: 30px;">
      <!-- Left: Computer Control -->
      <div class="schedule-card" style="flex: 1; min-width: 320px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
          <h4 style="margin: 0;"><i class="fa fa-desktop" aria-hidden="true"></i> Computer Control</h4>
          <button id="submitPcStatus" style="background: #2196f3; color: white; border: none; border-radius: 4px; padding: 8px 18px; font-size: 14px; cursor: pointer;">Submit</button>
        </div>
        <div style="margin-bottom: 15px;">
          <label for="labSelect"><strong>Lab:</strong></label>
          <select id="labSelect" class="form-control" style="width: 100%; margin-top: 5px;">
            <option value="" disabled selected>Select a laboratory</option>
            {% for lab in labs %}
            <option value="{{ lab.lab_id }}" data-capacity="{{ lab.capacity }}">
              {{ lab.building }} - Room {{ lab.room_number }} ({{ lab.capacity }} PCs)
            </option>
            {% endfor %}
          </select>
        </div>
        <div id="pcListContainer">
          <div style="color: #888; text-align: center; padding: 30px 0;">
            <em>Select a lab to view PCs...</em>
          </div>
        </div>
        <div id="pcControlButtons" style="display: none; margin-top: 15px; text-align: center;">
          <button id="setAllAvailable" style="background: #4caf50; color: white; border: none; border-radius: 4px; padding: 8px 18px; margin-right: 10px; font-size: 14px; cursor: pointer;">Available</button>
          <button id="setAllUsed" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 8px 18px; font-size: 14px; cursor: pointer;">Used</button>
        </div>
      </div>
      <!-- Computer Control JS -->
      {% block scripts %}
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const labSelect = document.getElementById('labSelect');
          const pcListContainer = document.getElementById('pcListContainer');
          const pcControlButtons = document.getElementById('pcControlButtons');
          const setAllAvailable = document.getElementById('setAllAvailable');
          const setAllUsed = document.getElementById('setAllUsed');
          const submitPcStatus = document.getElementById('submitPcStatus');
          let currentCapacity = 0;

          // Function to fetch PC status from the server
          function fetchPcStatus(labId) {
            // Show loading indicator
            pcListContainer.innerHTML = '<div style="text-align: center; padding: 30px 0;"><em>Loading PC status...</em></div>';
            
            // Make the API call
            fetch(`/api/get_lab_pc_status/${labId}`)
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
              })
              .then(data => {
                currentCapacity = data.capacity;
                renderPCs(data.pc_status);
              })
              .catch(error => {
                console.error('Error fetching PC status:', error);
                pcListContainer.innerHTML = `<div style="color: #e53935; text-align: center; padding: 30px 0;">
                  <i class="fa fa-exclamation-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                  <p>Error loading PC status. Please try again.</p>
                </div>`;
              });
          }

          // Function to render PCs with status from server
          function renderPCs(pcStatus) {
            if (!pcStatus || pcStatus.length === 0) {
              // If no PC status, create default grid based on capacity
              let html = '<div id="pcGrid" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">';
              for (let i = 1; i <= currentCapacity; i++) {
                html += createPcBox(i, 'Available');
              }
              html += '</div>';
              pcListContainer.innerHTML = html;
            } else {
              // Render PC status from server data
              let html = '<div id="pcGrid" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">';
              for (let pc of pcStatus) {
                html += createPcBox(pc.pc_number, pc.status);
              }
              html += '</div>';
              pcListContainer.innerHTML = html;
            }
            pcControlButtons.style.display = '';
          }

          // Helper function to create PC box HTML
          function createPcBox(pcNumber, status) {
            const isAvailable = status === 'Available';
            const bgColor = isAvailable ? 'rgba(67,160,71,0.7)' : 'rgba(229,57,53,0.7)';
            const borderColor = isAvailable ? '#43a047' : '#e53935';
            
            return `<div class="pc-box ${status.toLowerCase()}" data-pc="${pcNumber}" style="border: 2px solid ${borderColor}; border-radius: 6px; padding: 10px 8px; min-width: 90px; text-align: center; background: ${bgColor}; color: #fff; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <div style="font-weight: bold; margin-bottom: 6px; color: #fff;">PC ${pcNumber}</div>
            </div>`;
          }

          // Lab selection change handler
          labSelect.addEventListener('change', function() {
            const selectedOption = labSelect.options[labSelect.selectedIndex];
            const labId = selectedOption.value;
            
            if (!labId) {
              pcListContainer.innerHTML = '<div style="color: #888; text-align: center; padding: 30px 0;"><em>Select a lab to view PCs...</em></div>';
              pcControlButtons.style.display = 'none';
              return;
            }
            
            // Fetch PC status from the server
            fetchPcStatus(labId);
          });

          // Toggle individual PC status
          pcListContainer.addEventListener('click', function(e) {
            const box = e.target.closest('.pc-box');
            if (box) {
              if (box.classList.contains('available')) {
                box.classList.remove('available');
                box.classList.add('used');
                box.style.background = 'rgba(229,57,53,0.7)';
                box.style.borderColor = '#e53935';
                box.style.color = '#fff';
              } else {
                box.classList.remove('used');
                box.classList.add('available');
                box.style.background = 'rgba(67,160,71,0.7)';
                box.style.borderColor = '#43a047';
                box.style.color = '#fff';
              }
            }
          });

          // Set all to available
          setAllAvailable.addEventListener('click', function() {
            const boxes = pcListContainer.querySelectorAll('.pc-box');
            boxes.forEach(box => {
              box.classList.remove('used');
              box.classList.add('available');
              box.style.background = 'rgba(67,160,71,0.7)';
              box.style.borderColor = '#43a047';
              box.style.color = '#fff';
            });
          });

          // Set all to used
          setAllUsed.addEventListener('click', function() {
            const boxes = pcListContainer.querySelectorAll('.pc-box');
            boxes.forEach(box => {
              box.classList.remove('available');
              box.classList.add('used');
              box.style.background = 'rgba(229,57,53,0.7)';
              box.style.borderColor = '#e53935';
              box.style.color = '#fff';
            });
          });

          // Submit PC status to the server
          submitPcStatus.addEventListener('click', function() {
            const selectedLab = labSelect.value;
            if (!selectedLab) {
              alert('Please select a laboratory first.');
              return;
            }
            
            // Change button to loading state
            submitPcStatus.disabled = true;
            submitPcStatus.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Submitting...';
            
            const boxes = pcListContainer.querySelectorAll('.pc-box');
            const pcStatus = Array.from(boxes).map(box => ({
              pc: parseInt(box.getAttribute('data-pc')),
              status: box.classList.contains('available') ? 'Available' : 'Used'
            }));
            
            // Send to server
            fetch('/api/update_lab_pc_status', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                lab_id: parseInt(selectedLab),
                pc_status: pcStatus
              }),
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              // Reset button state
              submitPcStatus.disabled = false;
              submitPcStatus.innerHTML = 'Submit';
              
              // Show success message
              const logContainer = document.getElementById('logsContainer');
              if (logContainer) {
                const timestamp = new Date().toLocaleTimeString();
                logContainer.innerHTML = `
                  <div style="color: #43a047; margin-bottom: 10px;">
                    <i class="fa fa-check-circle"></i> 
                    <strong>[${timestamp}]</strong> PC status for ${labSelect.options[labSelect.selectedIndex].text} updated successfully.
                  </div>` + logContainer.innerHTML;
              }
              
              // Update the PC status in reservation table if needed
              updateReservationTablePCs();
            })
            .catch(error => {
              console.error('Error updating PC status:', error);
              // Reset button state
              submitPcStatus.disabled = false;
              submitPcStatus.innerHTML = 'Submit';
              
              // Show error
              alert('Error updating PC status. Please try again.');
            });
          });
          
          // Optional: function to update reservation table PCs
          function updateReservationTablePCs() {
            // This would update available PC numbers in any reservation forms
            // Can implement if needed
          }
        });
      </script>
      {% endblock %}
      <!-- Right: Reservation Requests -->
      <div class="schedule-card" style="flex: 2; min-width: 400px;">
        <h4><i class="fa fa-calendar-check-o" aria-hidden="true"></i> Reservation Requests</h4>
        
        <!-- Search Bar -->
        <div style="margin-bottom: 15px; display: flex; align-items: center;">
          <div style="position: relative; flex: 1;">
            <input type="text" id="reservationSearch" placeholder="Search by ID, date, lab, purpose..." 
                   style="width: 100%; padding: 8px 10px 8px 30px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            <i class="fa fa-search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666;"></i>
          </div>
          <select id="statusFilter" style="width: auto; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; margin-left: 10px; font-size: 14px;">
            <option value="all">All Status</option>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
            <option value="Cancelled">Cancelled</option>
          </select>
          <button id="resetSearch" style="background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; padding: 8px 15px; margin-left: 10px; cursor: pointer; font-size: 14px;">
            <i class="fa fa-refresh"></i> Reset
          </button>
        </div>
        
        {% if reservations %}
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="padding: 8px; border-bottom: 1px solid #ddd">ID Number</th>
              <th style="padding: 8px; border-bottom: 1px solid #ddd">Reservation Date</th>
              <th style="padding: 8px; border-bottom: 1px solid #ddd">Reservation Time</th>
              <th style="padding: 8px; border-bottom: 1px solid #ddd">Laboratory</th>
              <th style="padding: 8px; border-bottom: 1px solid #ddd">Computer Number</th>
              <th style="padding: 8px; border-bottom: 1px solid #ddd">Purpose</th>
              <th style="padding: 8px; border-bottom: 1px solid #ddd">Status</th>
              <th style="padding: 8px; border-bottom: 1px solid #ddd">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for r in reservations %}
            <tr data-reservation-id="{{ r.reservation_id }}" class="reservation-row {% if r.status == 'Pending' %}pending-row{% endif %}">
              <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">{{ r.student_id }}</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">{{ r.reservation_date }}</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">{{ r.start_time }} - {{ r.end_time }}</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">{{ r.building }} - Room {{ r.room_number }}</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;" class="pc-number-cell">
                {% if r.computer_number %}
                  {{ r.computer_number }}
                {% else %}
                  {% if r.status == 'Pending' %}
                  <select class="pc-select" style="width: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 2px;" data-lab-id="{{ r.lab_id }}" data-reservation-date="{{ r.reservation_date }}" data-start-time="{{ r.start_time }}" data-end-time="{{ r.end_time }}">
                    <option value="">Auto</option>
                  </select>
                  {% else %}
                  -
                  {% endif %}
                {% endif %}
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">{{ r.purpose }}</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;" class="status-cell">
                {% if r.status == 'Approved' %}
                <span style="background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 4px; font-size: 12px;">Approved</span>
                {% elif r.status == 'Rejected' %}
                <span style="background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 4px; font-size: 12px;">Rejected</span>
                {% elif r.status == 'Cancelled' %}
                <span style="background: #e2e3e5; color: #383d41; padding: 3px 8px; border-radius: 4px; font-size: 12px;">Cancelled</span>
                {% else %}
                <span style="background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 4px; font-size: 12px;">Pending</span>
                {% endif %}
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;" class="action-cell">
                {% if r.status == 'Pending' %}
                <button class="approve-btn" style="background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 5px 12px; margin-right: 5px; cursor: pointer;">Approve</button>
                <button class="deny-btn" style="background: #e53935; color: #fff; border: none; border-radius: 4px; padding: 5px 12px; cursor: pointer;">Deny</button>
                {% else %}
                <button class="view-btn" style="background: #2196F3; color: #fff; border: none; border-radius: 4px; padding: 5px 12px; cursor: pointer;">View</button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No reservations found.</p>
        {% endif %}
      </div>
    </div>
    
    <!-- Reservation Modals -->
    <div id="rejectModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
      <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 50%; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3 style="margin-top: 0;">Reject Reservation</h3>
        <p>Please provide a reason for rejecting this reservation:</p>
        <textarea id="rejectionReason" style="width: 100%; height: 100px; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        <div style="text-align: right;">
          <button id="cancelReject" style="background: #f5f5f5; color: #333; border: none; border-radius: 4px; padding: 8px 15px; margin-right: 10px; cursor: pointer;">Cancel</button>
          <button id="confirmReject" style="background: #e53935; color: #fff; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer;">Reject</button>
        </div>
        <input type="hidden" id="rejectReservationId" value="">
      </div>
    </div>
    
    <div id="viewModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
      <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 50%; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3 style="margin-top: 0;">Reservation Details</h3>
        <div id="reservationDetails" style="margin-top: 15px;">
          <!-- Details will be populated dynamically -->
        </div>
      </div>
    </div>
    
    <!-- Logs container below -->
    <div class="content-row" style="margin-top: 20px;">
      <div class="schedule-card" style="width: 100%;">
        <h4><i class="fa fa-history" aria-hidden="true"></i> Reservation History</h4>
        <div id="logsContainer" style="max-height: 350px; overflow-y: auto;">
          {% if processed_reservations %}
            {% for r in processed_reservations %}
              {% if r.status == 'Approved' %}
                {% set bg_color = '#d4edda' %}
                {% set text_color = '#155724' %}
                {% set icon_class = 'fa-check-circle' %}
              {% elif r.status == 'Rejected' %}
                {% set bg_color = '#f8d7da' %}
                {% set text_color = '#721c24' %}
                {% set icon_class = 'fa-exclamation-circle' %}
              {% else %}
                {% set bg_color = '#e2e3e5' %}
                {% set text_color = '#383d41' %}
                {% set icon_class = 'fa-info-circle' %}
              {% endif %}
              <div style="margin-bottom: 10px; padding: 8px; border-radius: 4px; background-color: {{ bg_color }}; color: {{ text_color }};">
                <i class="fa {{ icon_class }}"></i>
                <strong>[{{ r.approval_date.replace(' ', ' - ') if r.approval_date else r.created_at.replace(' ', ' - ') }}]</strong>
                Reservation for {{ r.student_id }} ({{ r.firstname }} {{ r.lastname }}) at {{ r.building }} - Room {{ r.room_number }} on {{ r.reservation_date }} ({{ r.start_time }} - {{ r.end_time }})
                {% if r.status == 'Approved' %}
                  approved. PC #{{ r.computer_number }} assigned.
                {% elif r.status == 'Rejected' %}
                  rejected. Reason: {{ r.rejection_reason }}.
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div style="color: #888; text-align: center; padding: 30px 0;">
              <em>No processed reservations found...</em>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add JavaScript for reservation approvals/rejections -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get modal elements
    const rejectModal = document.getElementById('rejectModal');
    const viewModal = document.getElementById('viewModal');
    const rejectReasonTextarea = document.getElementById('rejectionReason');
    const rejectReservationIdInput = document.getElementById('rejectReservationId');
    const confirmRejectBtn = document.getElementById('confirmReject');
    const cancelRejectBtn = document.getElementById('cancelReject');
    const closeButtons = document.querySelectorAll('.close');
    
    // Search and filter functionality
    const searchInput = document.getElementById('reservationSearch');
    const statusFilter = document.getElementById('statusFilter');
    const reservationRows = document.querySelectorAll('.reservation-row');
    
    // Function to filter reservations
    function filterReservations() {
      const searchTerm = searchInput.value.toLowerCase();
      const statusValue = statusFilter.value;
      
      reservationRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const studentId = cells[0].textContent.toLowerCase();
        const reservationDate = cells[1].textContent.toLowerCase();
        const reservationTime = cells[2].textContent.toLowerCase();
        const laboratory = cells[3].textContent.toLowerCase();
        const purpose = cells[5].textContent.toLowerCase();
        const status = cells[6].querySelector('span') ? cells[6].querySelector('span').textContent.trim() : '';
        
        // Check if the row matches the search term
        const matchesSearch = searchTerm === '' || 
          studentId.includes(searchTerm) || 
          reservationDate.includes(searchTerm) || 
          reservationTime.includes(searchTerm) || 
          laboratory.includes(searchTerm) || 
          purpose.includes(searchTerm);
        
        // Check if the row matches the status filter
        const matchesStatus = statusValue === 'all' || status === statusValue;
        
        // Show/hide the row based on filters
        row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
      });
      
      // Check if there are any visible rows
      checkVisibleRows();
    }
    
    // Function to check if there are any visible rows and show a message if not
    function checkVisibleRows() {
      let visibleCount = 0;
      reservationRows.forEach(row => {
        if (row.style.display !== 'none') {
          visibleCount++;
        }
      });
      
      // Get or create the no results message
      let noResultsMsg = document.getElementById('noSearchResults');
      if (!noResultsMsg) {
        noResultsMsg = document.createElement('tr');
        noResultsMsg.id = 'noSearchResults';
        noResultsMsg.innerHTML = '<td colspan="8" style="text-align: center; padding: 20px;">No matching reservations found.</td>';
        
        const tableBody = document.querySelector('table tbody');
        if (tableBody) {
          tableBody.appendChild(noResultsMsg);
        }
      }
      
      // Show/hide the message
      noResultsMsg.style.display = visibleCount === 0 ? '' : 'none';
    }
    
    // Add event listeners for search and filter
    if (searchInput) {
      searchInput.addEventListener('input', filterReservations);
    }
    
    if (statusFilter) {
      statusFilter.addEventListener('change', filterReservations);
    }
    
    // Reset button functionality
    const resetButton = document.getElementById('resetSearch');
    if (resetButton) {
      resetButton.addEventListener('click', function() {
        if (searchInput) searchInput.value = '';
        if (statusFilter) statusFilter.value = 'all';
        
        // Show all rows again
        reservationRows.forEach(row => {
          row.style.display = '';
        });
        
        // Hide the no results message if it exists
        const noResultsMsg = document.getElementById('noSearchResults');
        if (noResultsMsg) {
          noResultsMsg.style.display = 'none';
        }
      });
    }
    
    // Initialize PC selects
    document.querySelectorAll('.pc-select').forEach(select => {
      const labId = select.getAttribute('data-lab-id');
      const reservationDate = select.getAttribute('data-reservation-date');
      const startTime = select.getAttribute('data-start-time');
      const endTime = select.getAttribute('data-end-time');
      
      // Fetch lab information and available PCs
      fetchLabCapacityAndAvailablePCs(labId, reservationDate, startTime, endTime, select);
    });
    
    // Function to fetch lab capacity and populate PC numbers
    function fetchLabCapacityAndAvailablePCs(labId, reservationDate, startTime, endTime, selectElement) {
      // First fetch the lab capacity
      fetch(`/api/get_lab_pc_status/${labId}`)
        .then(response => {
          if (!response.ok) throw new Error('Failed to get lab information');
          return response.json();
        })
        .then(data => {
          // We now have the lab capacity
          const capacity = data.capacity;
          
          // Next, fetch any already booked PCs for this time slot
          fetch(`/api/get_booked_pcs?lab_id=${labId}&date=${reservationDate}&start_time=${startTime}&end_time=${endTime}`)
            .then(response => {
              if (!response.ok) {
                // If endpoint doesn't exist yet, just populate all PCs
                populatePCOptions(selectElement, capacity, []);
                return;
              }
              return response.json();
            })
            .then(bookedData => {
              if (bookedData) {
                const bookedPCs = bookedData.booked_pcs || [];
                populatePCOptions(selectElement, capacity, bookedPCs);
              }
            })
            .catch(error => {
              // If there's an error fetching booked PCs, just show all PCs
              console.error('Error fetching booked PCs:', error);
              populatePCOptions(selectElement, capacity, []);
            });
        })
        .catch(error => {
          console.error('Error fetching lab capacity:', error);
          // Fallback to a reasonable number if we can't get the capacity
          populatePCOptions(selectElement, 30, []);
        });
    }
    
    // Function to populate PC options
    function populatePCOptions(selectElement, capacity, bookedPCs) {
      // Keep the "Auto" option
      selectElement.innerHTML = '<option value="">Auto</option>';
      
      // Add PC options
      for (let i = 1; i <= capacity; i++) {
        // Skip PCs that are already booked
        if (bookedPCs.includes(i)) continue;
        
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        selectElement.appendChild(option);
      }
    }
    
    // Add event listeners to approve buttons
    document.querySelectorAll('.approve-btn').forEach(button => {
      button.addEventListener('click', function() {
        const row = this.closest('tr');
        const reservationId = row.getAttribute('data-reservation-id');
        const pcSelect = row.querySelector('.pc-select');
        const pcNumber = pcSelect ? pcSelect.value : null;
        
        // Show loading state
        this.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
        this.disabled = true;
        row.querySelector('.deny-btn').disabled = true;
        
        approveReservation(reservationId, pcNumber, row);
      });
    });
    
    // Add event listeners to deny buttons
    document.querySelectorAll('.deny-btn').forEach(button => {
      button.addEventListener('click', function() {
        const row = this.closest('tr');
        const reservationId = row.getAttribute('data-reservation-id');
        
        // Show the reject modal and set the reservation ID
        rejectModal.style.display = 'block';
        rejectReservationIdInput.value = reservationId;
        rejectReasonTextarea.focus();
      });
    });
    
    // Add event listeners to view buttons
    document.querySelectorAll('.view-btn').forEach(button => {
      button.addEventListener('click', function() {
        const row = this.closest('tr');
        const reservationId = row.getAttribute('data-reservation-id');
        
        // Show loading state
        this.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
        this.disabled = true;
        
        // Get reservation details from the table row
        const cells = row.querySelectorAll('td');
        const studentId = cells[0].textContent.trim();
        const date = cells[1].textContent.trim();
        const time = cells[2].textContent.trim();
        const laboratory = cells[3].textContent.trim();
        const pcNumber = cells[4].textContent.trim();
        const purpose = cells[5].textContent.trim();
        const status = cells[6].querySelector('span').textContent.trim();
        
        // Fill the view modal
        const detailsHtml = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><strong>Student ID:</strong> ${studentId}</div>
            <div><strong>Status:</strong> ${status}</div>
            <div><strong>Date:</strong> ${date}</div>
            <div><strong>Time:</strong> ${time}</div>
            <div><strong>Laboratory:</strong> ${laboratory}</div>
            <div><strong>Computer:</strong> ${pcNumber}</div>
            <div style="grid-column: span 2;"><strong>Purpose:</strong> ${purpose}</div>
          </div>
        `;
        
        document.getElementById('reservationDetails').innerHTML = detailsHtml;
        viewModal.style.display = 'block';
        
        // Reset button state
        this.innerHTML = 'View';
        this.disabled = false;
      });
    });
    
    // Handle confirmation of reservation rejection
    confirmRejectBtn.addEventListener('click', function() {
      const reservationId = rejectReservationIdInput.value;
      const reason = rejectReasonTextarea.value.trim();
      
      if (!reason) {
        alert('Please provide a reason for rejection');
        return;
      }
      
      // Get the row to update
      const row = document.querySelector(`tr[data-reservation-id="${reservationId}"]`);
      if (!row) return;
      
      // Show loading state
      confirmRejectBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
      confirmRejectBtn.disabled = true;
      cancelRejectBtn.disabled = true;
      
      rejectReservation(reservationId, reason, row);
    });
    
    // Close modals when clicking cancel or X
    cancelRejectBtn.addEventListener('click', function() {
      rejectModal.style.display = 'none';
      rejectReasonTextarea.value = '';
    });
    
    closeButtons.forEach(button => {
      button.addEventListener('click', function() {
        rejectModal.style.display = 'none';
        viewModal.style.display = 'none';
        rejectReasonTextarea.value = '';
      });
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target === rejectModal) {
        rejectModal.style.display = 'none';
        rejectReasonTextarea.value = '';
      }
      if (event.target === viewModal) {
        viewModal.style.display = 'none';
      }
    });
    
    // Function to approve a reservation
    function approveReservation(reservationId, pcNumber, row) {
      fetch('/api/approve_reservation', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          reservation_id: reservationId,
          pc_number: pcNumber === '' ? null : pcNumber
        }),
      })
      .then(response => {
        if (!response.ok) {
          throw response;
        }
        return response.json();
      })
      .then(data => {
        // Get row data for log entry
        const cells = row.querySelectorAll('td');
        const studentId = cells[0].textContent.trim();
        const date = cells[1].textContent.trim();
        const time = cells[2].textContent.trim();
        const laboratory = cells[3].textContent.trim();
        const pcNumberText = data.pc_number || "Auto-assigned";
        const purpose = cells[5].textContent.trim();
        
        // Add log message
        addLogMessage(`Reservation for ${studentId} at ${laboratory} on ${date} (${time}) approved. PC #${pcNumberText} assigned.`, 'success');
        
        // Remove row from table
        row.remove();
        
        // Check if the table is now empty
        checkEmptyTable();
        
        // Get the lab ID from the reservation data or the row
        const labId = data.reservation?.lab_id;
        
        // If we have the lab ID from the reservation data
        if (labId) {
          // First, select this lab in the dropdown to ensure we're viewing the relevant lab
          const labSelect = document.getElementById('labSelect');
          if (labSelect) {
            labSelect.value = labId;
            // Then refresh the PC status display for this lab
            fetchPcStatus(labId);
          }
        } else {
          // Fallback to the current selected lab
          const selectedLab = document.getElementById('labSelect')?.value;
          if (selectedLab) {
            fetchPcStatus(selectedLab);
          }
        }
      })
      .catch(error => {
        if (error.json) {
          error.json().then(errData => {
            alert(`Error: ${errData.error || 'Failed to approve reservation'}`);
          });
        } else {
          alert('Error: Failed to approve reservation');
        }
        
        // Reset button states
        const approveBtn = row.querySelector('.approve-btn');
        const denyBtn = row.querySelector('.deny-btn');
        approveBtn.innerHTML = 'Approve';
        approveBtn.disabled = false;
        denyBtn.disabled = false;
      });
    }
    
    // Function to reject a reservation
    function rejectReservation(reservationId, reason, row) {
      fetch('/api/reject_reservation', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          reservation_id: reservationId,
          rejection_reason: reason
        }),
      })
      .then(response => {
        if (!response.ok) {
          throw response;
        }
        return response.json();
      })
      .then(data => {
        // Close the modal
        rejectModal.style.display = 'none';
        
        // Get row data for log entry
        const cells = row.querySelectorAll('td');
        const studentId = cells[0].textContent.trim();
        const date = cells[1].textContent.trim();
        const time = cells[2].textContent.trim();
        const laboratory = cells[3].textContent.trim();
        const purpose = cells[5].textContent.trim();
        
        // Add log message
        addLogMessage(`Reservation for ${studentId} at ${laboratory} on ${date} (${time}) rejected. Reason: ${reason}`, 'danger');
        
        // Remove row from table
        row.remove();
        
        // Check if the table is now empty
        checkEmptyTable();
        
        // Reset the rejection reason
        rejectReasonTextarea.value = '';
      })
      .catch(error => {
        if (error.json) {
          error.json().then(errData => {
            alert(`Error: ${errData.error || 'Failed to reject reservation'}`);
          });
        } else {
          alert('Error: Failed to reject reservation');
        }
        
        // Reset button states
        confirmRejectBtn.innerHTML = 'Reject';
        confirmRejectBtn.disabled = false;
        cancelRejectBtn.disabled = false;
      });
    }
    
    // Function to check if the table is empty and show a message if it is
    function checkEmptyTable() {
      const tbody = document.querySelector('table tbody');
      if (tbody) {
        const visibleRows = Array.from(tbody.querySelectorAll('tr.reservation-row')).filter(row => row.style.display !== 'none');
        const allRows = tbody.querySelectorAll('tr.reservation-row');
        
        // Only show the empty message if there are truly no reservations
        if (allRows.length === 0) {
          const tableContainer = tbody.closest('.schedule-card');
          const message = document.createElement('p');
          message.textContent = 'No reservations found.';
          
          // Remove the table
          const table = tbody.closest('table');
          if (table) {
            table.remove();
          }
          
          // Add the message
          tableContainer.appendChild(message);
        }
      }
    }
    
    // Function to add log message to the logs container
    function addLogMessage(message, type) {
      const logsContainer = document.getElementById('logsContainer');
      const logElement = document.createElement('div');
      const timestamp = new Date().toLocaleTimeString();
      
      logElement.style.marginBottom = '10px';
      logElement.style.padding = '8px';
      logElement.style.borderRadius = '4px';
      
      if (type === 'success') {
        logElement.style.backgroundColor = '#d4edda';
        logElement.style.color = '#155724';
        logElement.innerHTML = `<i class="fa fa-check-circle"></i> <strong>[${new Date().toLocaleDateString()} - ${timestamp}]</strong> ${message}`;
      } else if (type === 'danger') {
        logElement.style.backgroundColor = '#f8d7da';
        logElement.style.color = '#721c24';
        logElement.innerHTML = `<i class="fa fa-exclamation-circle"></i> <strong>[${new Date().toLocaleDateString()} - ${timestamp}]</strong> ${message}`;
      } else {
        logElement.style.backgroundColor = '#e2e3e5';
        logElement.style.color = '#383d41';
        logElement.innerHTML = `<i class="fa fa-info-circle"></i> <strong>[${new Date().toLocaleDateString()} - ${timestamp}]</strong> ${message}`;
      }
      
      // Remove the placeholder if it exists
      const placeholder = logsContainer.querySelector('div[style*="color: #888"]');
      if (placeholder) {
        logsContainer.removeChild(placeholder);
      }
      
      // Insert at the beginning
      if (logsContainer.firstChild) {
        logsContainer.insertBefore(logElement, logsContainer.firstChild);
      } else {
        logsContainer.appendChild(logElement);
      }
    }
  });
</script>
{% endblock %} 